#!/usr/bin/perl

# TODO threaded with parents in index?

use Mojo::Base -strict, -signatures;
use Mojo::UserAgent;
use App::pickaxe::Index;
use App::pickaxe::Config;

use Curses;

our $VERSION = '0.01';

## Read config before the screen is initialized
## Config can write to stderr
my $config = App::pickaxe::Config->new;

if (@ARGV) {
    $config->base_url( shift @ARGV );
}

if ( !$config->base_url ) {
    die "Usage: $0 BASE_URL\n";
}

initscr;
keypad( stdscr, 1 );
noecho;
curs_set(0);

$SIG{__WARN__} = sub { die @_ };

eval { App::pickaxe::Index->new( config => $config )->run };

my $err;
if ($@) {
    $err = $@;
}

endwin;
if ($err) {
    warn $err;
}
exit 0;

__END__

=pod

=head1 NAME

pickaxe - the redmine wiki editor

=head1 SYNOPSIS

    pickaxe https://example.com/projects/example/

=head1 DESCRIPTION

Pickaxe is a terminal based programm to view and edit redmine wiki
pages.

When you start pickaxe your are prompted for your username and passwort
if those are not set in the configuration file. The index is the
first screen you see. It is a list of alle wiki pages in your current
project. You can use the I<Return> to view a wiki page in the pager
screen.

=head1 CONFIGURATION

When pickaxe is first invoked, it will attempt to read its configuration
file at I<$XDG_CONFIG_HOME/pickaxe/pickaxe.conf>

An configuration file consists of a series of commands. The only
valid commands are set and bind. Set is used to change configuration
variables. Bind allows you to change the default key bindings.

=head2 Setting variables

The set command is used to changed configuration variables. It takes the
variable name and its new value as arguments. For example:

    set pass_cmd pass mdom@example.org

The following variables are valid:

=over 4

=item pass_cmd

Command to get the users password. It should return the
password on stdout on a sinlge line.  There is no default.

=item yank_cmd

Command to copy the url of the current wiki page to the
clipboard. Defaults to I<xclip>.

=item username

Specifies the username for you redmine account. If this and
I<REDMINE_APIKEY> are no set pickaxe will prompt you for your
username. There is no default.

=item password

Specifies the passwort for you redmine account. If this and
I<REDMINE_APIKEY> are no set pickaxe will prompt you for your
password. There is no default.

=item base_url

Specifies the base url of the redmine project you want to edit.

=item index_time_format.

The I<strftime> format used in the index display. The default is
'%Y-%m-%d %H:%M:%S'.

=item index_format

This variable allows you to customize the index display. It uses format
strings similar to the C function I<printf(3)> to format output. The
default is '%4n %-22u %t'.

The following sequences are defined:

=over 4

=item %n

Current page number.

=item %u

The date the page was last updated, formatted with I<strftime> and the format
defined in I<index_time_format>.

=item %c

The date the page was created, formatted with I<strftime> and the format
defined in I<index_time_format>.

=item %t

The page title.

=item %v

The page version number.

=back

=back

=head1 ENVIRONMENT

=over 4

=item REDMINE_APIKEY

This variable has to be set in order to access the redmine api. You can
access it by clicking on your account on your redmine wiki and search
for api key in the right margin.

=back

=head1 COPYRIGHT AND LICENSE

Copyright 2022 Mario Domgoergen C<< <mario@domgoergen.com> >>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

=cut
